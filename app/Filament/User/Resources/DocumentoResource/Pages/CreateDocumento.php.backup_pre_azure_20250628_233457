<?php

namespace App\Filament\User\Resources\DocumentoResource\Pages;

use App\Filament\User\Resources\DocumentoResource;
use App\Services\AIService;
use Filament\Resources\Pages\CreateRecord;
use Filament\Notifications\Notification;
use Illuminate\Support\Facades\Log;

class CreateDocumento extends CreateRecord
{
    protected static string $resource = DocumentoResource::class;

    protected function getRedirectUrl(): string
    {
        return $this->getResource()::getUrl('index');
    }

    public function getBreadcrumbs(): array
    {
        return [];
    }

    protected function afterCreate(): void
    {
        // Processa il documento con ChatGPT dopo il salvataggio
        if (!empty($this->record->file)) {
            $this->processWithChatGPT($this->record->file);
        }
    }

    private function processWithChatGPT(string $filePath): void
    {
        try {
            Log::info('Processing document with ChatGPT', ['file' => $filePath]);

            $aiService = app(AIService::class);

            if (!$aiService->isConfigured()) {
                Notification::make()
                    ->title('📄 Documento salvato!')
                    ->body('Il documento è stato salvato correttamente.')
                    ->success()
                    ->send();
                return;
            }

            // Processa il documento per estrarre dati
            $result = $aiService->processDocumentScan($filePath);

            if ($result['success']) {
                $extracted = $result['extracted_data'];

                // *** SALVA I DATI NEL DATABASE ***
                $this->record->update([
                    'ai_testo_estratto' => $extracted['tutto_il_testo'] ?? 'Nessun testo riconosciuto',
                    'ai_processato' => true,
                    'ai_processato_at' => now(),
                ]);

                Log::info('Dati AI salvati nel database', [
                    'documento_id' => $this->record->id,
                    'testo_estratto_length' => strlen($extracted['tutto_il_testo'] ?? ''),
                    'dati_estratti' => $extracted
                ]);

                // Costruisci messaggio con dati estratti
                $details = [];

                if (!empty($extracted['descrizione'])) {
                    $details[] = "📝 " . $extracted['descrizione'];
                }

                if (!empty($extracted['importo'])) {
                    $details[] = "💰 CHF " . number_format($extracted['importo'], 2);
                }

                if (!empty($extracted['data_emissione'])) {
                    $details[] = "📅 Emissione: " . $extracted['data_emissione'];
                }

                if (!empty($extracted['data_scadenza'])) {
                    $details[] = "⏰ Scadenza: " . $extracted['data_scadenza'];
                }

                if (!empty($extracted['fornitore'])) {
                    $details[] = "🏢 " . $extracted['fornitore'];
                }

                if (!empty($extracted['numero_documento'])) {
                    $details[] = "🔢 N. " . $extracted['numero_documento'];
                }

                // Aggiungi info miglioramenti
                if (!empty($result['improvements_applied'])) {
                    $details[] = "🔧 Miglioramenti: " . implode(', ', $result['improvements_applied']);
                }

                $message = "🤖 ChatGPT ha analizzato il documento!";
                if (!empty($details)) {
                    $message .= "\n\n" . implode("\n", $details);
                }

                if (!empty($extracted['tutto_il_testo'])) {
                    $testoPreview = strlen($extracted['tutto_il_testo']) > 100 
                        ? substr($extracted['tutto_il_testo'], 0, 100) . '...'
                        : $extracted['tutto_il_testo'];
                    $message .= "\n\n📄 Testo riconosciuto:\n" . $testoPreview;
                }

                Notification::make()
                    ->title('✅ Analisi completata e salvata!')
                    ->body($message)
                    ->success()
                    ->persistent()
                    ->send();

                Log::info('ChatGPT processing successful', $extracted);
            } else {
                // Anche in caso di errore, segna come processato
                $this->record->update([
                    'ai_testo_estratto' => 'Errore nell\'elaborazione: ' . ($result['error'] ?? 'Errore sconosciuto'),
                    'ai_processato' => true,
                    'ai_processato_at' => now(),
                ]);

                Notification::make()
                    ->title('📄 Documento salvato!')
                    ->body('Il documento è stato salvato. Elaborazione AI non riuscita.')
                    ->warning()
                    ->send();
            }

        } catch (\Exception $e) {
            Log::error('ChatGPT processing error: ' . $e->getMessage());

            // Salva l'errore nel database
            $this->record->update([
                'ai_testo_estratto' => 'Errore nell\'elaborazione: ' . $e->getMessage(),
                'ai_processato' => true,
                'ai_processato_at' => now(),
            ]);

            Notification::make()
                ->title('📄 Documento salvato!')
                ->body('Il documento è stato salvato correttamente.')
                ->success()
                ->send();
        }
    }
}
